{% extends "layout/base.html" %} 

{% load static %} 

{% block 'title'%}Calendar{%endblock 'title' %} 

{% block 'content' %}

<div class="hidden lg:block">
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-5 md:gap-6">
    <!-- Metric Item Start -->
    <div class="rounded-box border-2 border-base-300 bg-base-100  dark:border-gray-800 dark:bg-white/[0.03] md:p-6 flex flex-col items-start">
      <div class="flex flex-col items-start">
        <div class="flex h-12 w-12 items-center justify-center rounded-xl text-success">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-9 text-success">
            <path fill-rule="evenodd" d="M9 1.5H5.625c-1.036 0-1.875.84-1.875 1.875v17.25c0 1.035.84 1.875 1.875 1.875h12.75c1.035 0 1.875-.84 1.875-1.875V12.75A3.75 3.75 0 0 0 16.5 9h-1.875a1.875 1.875 0 0 1-1.875-1.875V5.25A3.75 3.75 0 0 0 9 1.5Zm6.61 10.936a.75.75 0 1 0-1.22-.872l-3.236 4.53L9.53 14.47a.75.75 0 0 0-1.06 1.06l2.25 2.25a.75.75 0 0 0 1.14-.094l3.75-5.25Z" clip-rule="evenodd" />
            <path d="M12.971 1.816A5.23 5.23 0 0 1 14.25 5.25v1.875c0 .207.168.375.375.375H16.5a5.23 5.23 0 0 1 3.434 1.279 9.768 9.768 0 0 0-6.963-6.963Z" />
          </svg>
        </div>
        <div class="mt-3 flex flex-col items-start w-full">
          <span class="text-md text-base-content">Tasks Completed</span>
          <h4 class="mt-2 text-2xl md:text-3xl font-bold text-base-content/90">{{ taskPostedCount }}</h4>
        </div>
      </div>
    </div>
    <!-- Metric Item End -->

    <!-- Pending -->
    <div class="rounded-2xl border-2 border-base-300 bg-base-100 p-5 dark:border-gray-800 dark:bg-white/[0.03] md:p-6 flex flex-col items-start">
      <div class="flex flex-col items-start">
        <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-base-100">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-9 text-warning">
            <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25ZM12.75 6a.75.75 0 0 0-1.5 0v6c0 .414.336.75.75.75h4.5a.75.75 0 0 0 0-1.5h-3.75V6Z" clip-rule="evenodd" />
          </svg>
        </div>
        <div class="mt-3 flex flex-col items-start w-full">
          <span class="text-md text-base-content">Tasks Pending</span>
          <h4 class="mt-2 text-2xl md:text-3xl font-bold text-base-content/90">{{taskPendingCount}} </h4>
        </div>
      </div>
    </div>

    <!-- Missed -->
    <div class="rounded-2xl border-2 border-base-300 bg-base-100 p-5 dark:border-gray-800 dark:bg-white/[0.03] md:p-6 flex flex-col items-start">
      <div class="flex flex-col items-start">
        <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-base-100">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-9 text-error">
            <path d="M3.375 3C2.339 3 1.5 3.84 1.5 4.875v.75c0 1.036.84 1.875 1.875 1.875h17.25c1.035 0 1.875-.84 1.875-1.875v-.75C22.5 3.839 21.66 3 20.625 3H3.375Z" />
            <path fill-rule="evenodd" d="m3.087 9 .54 9.176A3 3 0 0 0 6.62 21h10.757a3 3 0 0 0 2.995-2.824L20.913 9H3.087Zm6.133 2.845a.75.75 0 0 1 1.06 0l1.72 1.72 1.72-1.72a.75.75 0 1 1 1.06 1.06l-1.72 1.72 1.72 1.72a.75.75 0 1 1-1.06 1.06L12 15.685l-1.72 1.72a.75.75 0 1 1-1.06-1.06l1.72-1.72-1.72-1.72a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" />
          </svg>
        </div>
        <div class="mt-3 flex flex-col items-start w-full">
          <span class="text-md text-base-content">Tasks Missed</span>
          <h4 class="mt-2 text-2xl md:text-3xl font-bold text-base-content/90">{{taskMissedCount}} </h4>
        </div>
      </div>
    </div>
  </div>
  {% comment %} end metrics {% endcomment %}
  <div class="my-8 border border-base-300 rounded-2xl p-2 sm:p-5 shadow-2xl">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 h-auto md:h-[675px]">
      <!-- First row: Headings -->
      <div class="flex items-center">
      </div>
      <div class="col-span-2 flex items-center">
        <!-- Optionally, you can put a calendar heading here, or leave empty for alignment -->
      </div>
      <!-- Second row: Content -->
      <div class="flex flex-col gap-3 overflow-y-auto max-h-full min-w-0">
        <div class="sticky top-0 z-10 bg-base-100 pb-2">
          {% if taskPendingCount %}
            <h1 class="text-xl md:text-2xl font-bold">Pending Tasks</h1>
          {% else %}
            <h1 class="text-xl md:text-2xl font-bold">No Pending Tasks</h1>
          {% endif %}
        </div>

        {% for item in tasksPendingWithStaff %}
        <div class="bg-primary p-3 md:p-5 rounded-2xl max-h-20 flex flex-col md:flex-row items-center gap-3 md:gap-5 overflow-hidden w-full">
          <div class="flex flex-col items-center flex-shrink-0 flex-grow-0">
              <h1 class="text-lg md:text-2xl font-bold leading-none ">
              {{ item.task.deadline|date:"b"|upper }}
              </h1>
            <h1 class="text-2xl md:text-4xl font-extrabold leading-none mt-0">
              {{ item.task.deadline|date:"d" }}
            </h1>
          </div>
          <div class="flex flex-col items-baseline flex-1 min-w-0 overflow-hidden">
            <div class="text-xl font-bold block w-full text-ellipsis overflow-hidden whitespace-nowrap tooltip tooltip-top" data-tip="{{item.task.title}}">
              {{item.task.title}}
            </div>
            <div class="block w-full text-ellipsis overflow-hidden whitespace-nowrap tooltip">
              <div class="tooltip-content">
                {% for abbr in item.staff_display %}{{ abbr }} {% endfor %}
              </div>
              {{ item.staff_display|join:" " }}
            </div>
          </div>
        </div>
        {% endfor %}




      </div>
      <div class="col-span-2">
        <div id="calendar" class="h-[400px] md:h-full w-full"></div>
      </div>
    </div>
  </div>
</div>

<div class="lg:hidden flex flex-col items-center justify-center h-full text-center p-4">
  {% block 'error-view' %}
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-24 h-24 text-warning mb-4">
    <path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.992-1.45 1.746v.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 5.25h.008v.008H12v-.008Z" />
  </svg>
  <h2 class="text-3xl font-bold mb-2">View Not Supported</h2>
  <p class="text-lg text-gray-600">This calendar view is not optimized for smaller screens. Please use a device with a larger screen for the best experience.</p>
  {% endblock 'error-view' %}
</div>

{% comment %} <script src="{% static 'js/calendar.js' %}"></script> {% endcomment %}


{% include "task/taskAddModal.html" %}
{% include "task/taskEditModal.html" %}



<script>
  document.addEventListener('DOMContentLoaded', function() {
  var calendarEl = document.getElementById('calendar');

  var calendar = new FullCalendar.Calendar(calendarEl, {
    dateClick: function(info) {
      document.getElementById('deadline').value = info.dateStr;
      add_task_modal.showModal()
    },

    eventClick: function(info) {
      // Populate edit modal fields with event data
      const event = info.event;
      document.querySelector('#edit_task_modal [name="title"]').value = event.title || '';
      document.querySelector('#edit_task_modal [name="deadline"]').value = event.start ? event.start.toISOString().slice(0, 10) : '';
      // Adjust for timezone offset to get local date in YYYY-MM-DD
      let localDate = '';
      if (event.start) {
        const tzOffset = event.start.getTimezoneOffset() * 60000;
        const localISO = new Date(event.start.getTime() - tzOffset).toISOString().slice(0, 10);
        localDate = localISO;
      }
      console.log(localDate);
      document.querySelector('#edit_task_modal [name="deadline"]').value = localDate;
      document.querySelector('#edit_task_modal [name="description"]').value = event.extendedProps.description || '';
      document.querySelector('#edit_task_modal [name="task_type"]').value = event.extendedProps.task_type || '';
      document.querySelector('#edit_task_modal [name="task_id"]').value = event.id || '';
      // Set google_event_id in the edit form if present
      let googleEventId = event.extendedProps.google_event_id || '';
      document.querySelector('#edit_task_modal [name="google_event_id"]').value = googleEventId;

      // Ensure the status dropdown is updated visually (for DaisyUI or custom select)
      const statusSelect = document.querySelector('#edit_task_modal [name="status"]');
      if (statusSelect) {
        statusSelect.value = event.extendedProps.status || '';
        // Trigger change event in case a custom UI is used
        statusSelect.dispatchEvent(new Event('change', { bubbles: true }));
      }
      // Populate staff/role assignments
      const assignments = event.extendedProps.assignments || [];
      const modalBox = document.getElementById('edit_task_modal').querySelector('.modal-box');
      const container = modalBox.querySelector('.staff-role-container');
      // Remove all rows except the first
      let rows = container.querySelectorAll('.staff-role-row');
      rows.forEach((row, idx) => { if (idx > 0) row.remove(); });
      let firstRow = container.querySelector('.staff-role-row');
      // If there are assignments, fill them in
      if (assignments.length > 0) {
        assignments.forEach((assignment, idx) => {
          let row;
          if (idx === 0) {
            row = firstRow;
          } else {
            row = firstRow.cloneNode(true);
            container.appendChild(row);
          }
          // Set role
          const roleSelect = row.querySelector('.role-select');
          roleSelect.value = assignment.role_id;
          // Populate staff dropdown for this role
          const staffSelect = row.querySelector('.staff-select');
          staffSelect.innerHTML = '<option value="">Select Staff</option>';
          if (assignment.role_id && staffData[assignment.role_id]) {
            staffData[assignment.role_id].forEach(staff => {
              const opt = document.createElement('option');
              opt.value = staff.id;
              opt.textContent = staff.name;
              staffSelect.appendChild(opt);
            });
          }
          staffSelect.value = assignment.staff_id;
        });
      } else {
        // If no assignments, reset first row
        firstRow.querySelector('.role-select').selectedIndex = 0;
        firstRow.querySelector('.staff-select').innerHTML = '<option value="">Select Staff</option>';
      }
      updateRemoveButtons(container);
      edit_task_modal.showModal();
    },  

    initialView: 'dayGridMonth',
    initialDate: new Date(),
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'dayGridMonth,timeGridWeek,timeGridDay'
    },
    
    eventClassNames: function(arg) {
      // Use DaisyUI classes for event color and status
      let classes = ['rounded-lg', 'border-none', 'shadow', 'hover:opacity-90'];
      if (arg.event.extendedProps && arg.event.extendedProps.status) {
        const status = arg.event.extendedProps.status;
        const className = 'event-' + status.replace(/_/g, '_');
        classes.push(className);
      }
      return classes;
    },
    eventDidMount: function(info) {
      // Remove all previous event-* classes
      info.el.className = info.el.className.split(' ').filter(cls => !cls.startsWith('event-')).join(' ');
      if (info.event.extendedProps && info.event.extendedProps.status) {
        const status = info.event.extendedProps.status;
        const className = 'event-' + status.replace(/_/g, '_');
        info.el.classList.add(className);
      }
    },
    dayMaxEvents: true, // allow "more" link when too many events
    events: {{ events_json|safe }},
  });

  calendar.render();
});
</script>



<script>
const staffData = {{ staff_by_role_json|safe }}; // Pass this from your Django view as a JSON dict: {role_id: [{id, name}, ...]}
function updateStaffOptions(roleSelect) {
  const staffSelect = roleSelect.closest('.staff-role-row').querySelector('.staff-select');
  const roleId = roleSelect.value;
  staffSelect.innerHTML = '<option value="">Select Staff</option>';
  if (roleId && staffData[roleId]) {
    staffData[roleId].forEach(staff => {
      const opt = document.createElement('option');
      opt.value = staff.id;
      opt.textContent = staff.name;
      staffSelect.appendChild(opt);
    });
  }
}

document.addEventListener('change', function(e) {
  if (e.target.classList.contains('role-select')) {
    updateStaffOptions(e.target);
  }
});

// Delegated add row handler for both modals
// (works for .add-staff-role-btn in both add and edit modals)
document.body.addEventListener('click', function(e) {
  if (e.target.closest('.add-staff-role-btn')) {
    const modalBox = e.target.closest('.modal-box');
    const container = modalBox.querySelector('.staff-role-container');
    const firstRow = container.querySelector('.staff-role-row');
    const newRow = firstRow.cloneNode(true);
    // Reset selects
    newRow.querySelector('.role-select').selectedIndex = 0;
    newRow.querySelector('.staff-select').innerHTML = '<option value="">Select Staff</option>';
    container.appendChild(newRow);
    updateRemoveButtons(container);
  }
});

// Delegated remove row handler for both modals
document.body.addEventListener('click', function(e) {
  if (e.target.closest('.remove-row-btn')) {
    const btn = e.target.closest('.remove-row-btn');
    const modalBox = btn.closest('.modal-box');
    const container = modalBox.querySelector('.staff-role-container');
    const row = btn.closest('.staff-role-row');
    if (container.querySelectorAll('.staff-role-row').length > 1) {
      row.remove();
      updateRemoveButtons(container);
    }
  }
});

// Update remove button visibility for a given container
function updateRemoveButtons(container) {
  const rows = container.querySelectorAll('.staff-role-row');
  rows.forEach(row => row.querySelector('.remove-row-btn').classList.add('invisible'));
  if (rows.length > 1) {
    rows.forEach(row => row.querySelector('.remove-row-btn').classList.remove('invisible'));
  }
}

// On page load and after modal open, ensure remove button visibility is correct
function initStaffRoleModals() {
  document.querySelectorAll('.modal-box .staff-role-container').forEach(container => {
    updateRemoveButtons(container);
  });
}
document.addEventListener('DOMContentLoaded', initStaffRoleModals);
document.body.addEventListener('htmx:afterSettle', initStaffRoleModals);
</script>
{% comment %} tasks for calendar {% endcomment %}

<script>
document.addEventListener('DOMContentLoaded', function() {
  const makeWebhookUrl = "https://hook.us2.make.com/u1lim7ga3y77ppzajhkc845lropo2cvt";
  const addTaskForm = document.querySelector('#add_task_modal form');
  const editTaskForm = document.querySelector('#edit_task_modal form');
  
  if (addTaskForm) {
    let isSubmittingToMake = false;
    addTaskForm.addEventListener('submit', async function(e) {
      if (isSubmittingToMake) return;
      e.preventDefault();
      isSubmittingToMake = true;

      try {
        // Build the staff-role summary and collect assignments
        let staffRoleSummary = '';
        const attendees = [];
        const formData = new FormData(addTaskForm);
        const taskTypeSelect = addTaskForm.querySelector('[name="task_type"]');
        const taskTypeForMake = taskTypeSelect ? taskTypeSelect.options[taskTypeSelect.selectedIndex]?.text?.trim() : '';
        const userDesc = formData.get('description') || '';

        console.log('Initial staffData:', staffData);
        console.log('Detailed staffData structure:', JSON.stringify(staffData, null, 2));
        
        addTaskForm.querySelectorAll('.staff-role-row').forEach((row, index) => {
          const roleSelect = row.querySelector('.role-select');
          const staffSelect = row.querySelector('.staff-select');
          const roleId = roleSelect.value;
          const staffId = staffSelect.value;
          const roleName = roleSelect.options[roleSelect.selectedIndex]?.text?.trim();
          const staffName = staffSelect.options[staffSelect.selectedIndex]?.text?.trim();
          
          console.log(`Row ${index + 1} data:`, {
            roleId,
            staffId,
            roleName,
            staffName,
            roleSelectOptions: Array.from(roleSelect.options).map(opt => ({ value: opt.value, text: opt.text })),
            staffSelectOptions: Array.from(staffSelect.options).map(opt => ({ value: opt.value, text: opt.text }))
          });
          
          if (roleId && staffId) {
            console.log(`Looking up staff member for role ${roleId} and staff ${staffId}`);
            console.log('Available staff for this role:', staffData[roleId]);
            
            const staffMembers = staffData[roleId];
            console.log('Staff members for role:', staffMembers);
            
            staffMembers?.forEach(staff => {
              console.log('Staff member structure:', staff);
            });
            
            const staffMember = staffMembers?.find(staff => {
              console.log('Comparing:', { staffId, staffValue: staff.id });
              return staff.id === parseInt(staffId);
            });
            
            console.log('Found staff member:', staffMember);
            
            if (staffMember?.email) {
              console.log('Adding attendee with email:', staffMember.email);
              attendees.push({ email: staffMember.email });
              console.log('Current attendees array:', JSON.stringify(attendees));
            } else {
              console.log('No email found for staff member');
            }
            
            if (roleName && staffName && staffName !== 'Select Staff') {
              staffRoleSummary += `${roleName} - ${staffName}\n`;
            }
          }
        });

        console.log('Final attendees array before data object:', JSON.stringify(attendees));

        let finalDescriptionForMake = '';
        if (taskTypeForMake) {
            finalDescriptionForMake += taskTypeForMake.toUpperCase();
            finalDescriptionForMake += ' PENDING';
        }

        if (userDesc) {
            if (finalDescriptionForMake) finalDescriptionForMake += '\n';
            finalDescriptionForMake += userDesc;
        }

        if (staffRoleSummary) {
            if (finalDescriptionForMake) finalDescriptionForMake += '\n\n';
            finalDescriptionForMake += staffRoleSummary;
        }

        const data = {
          action: 'add',
          title: formData.get('title'),
          description: finalDescriptionForMake,
          deadline: formData.get('deadline'),
          task_type: formData.get('task_type'),
          status: 'PENDING',
          google_event_id: formData.get('google_event_id'),
          staff_role_summary: staffRoleSummary,
          attendees: [...attendees]  // Create a new array to ensure we're not losing the data
        };

        console.log('Final data being sent to Make.com:', JSON.stringify(data, null, 2));

        try {
          const response = await fetch(makeWebhookUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          const responseText = await response.text();
          
          if (!response.ok) {
            throw new Error('Failed to sync with Google Calendar');
          }

          // Parse the response to get the Google Calendar event ID
          try {
            const responseData = JSON.parse(responseText);
            if (responseData.google_event_id) {
              document.querySelector('#add_task_modal [name="google_event_id"]').value = responseData.google_event_id;
            }
          } catch (parseError) {
            // Ignore parse errors
          }

          addTaskForm.submit();
        } catch (err) {
          isSubmittingToMake = false;
          alert('Failed to sync with Google Calendar. Please try again.');
        }
      } catch (err) {
        isSubmittingToMake = false;
        alert('An error occurred. Please try again.');
      }
    });
  }

  if (editTaskForm) {
    let isSubmittingToMake = false;
    
    const deleteBtn = editTaskForm.querySelector('button[name="delete_task"]');
    if (deleteBtn) {
      deleteBtn.addEventListener('click', async function(e) {
        e.preventDefault();
        const formData = new FormData(editTaskForm);
        const googleEventId = formData.get('google_event_id');
        
        if (!googleEventId) {
          editTaskForm.setAttribute('data-delete', '1');
          let actionInput = editTaskForm.querySelector('[name="action"]');
          if (!actionInput) {
            actionInput = document.createElement('input');
            actionInput.type = 'hidden';
            actionInput.name = 'action';
            editTaskForm.appendChild(actionInput);
          }
          actionInput.value = 'delete';
          editTaskForm.dispatchEvent(new Event('submit'));
          return;
        }

        const deleteData = {
          action: 'delete',
          task_id: formData.get('task_id'),
          google_event_id: googleEventId
        };
        
        try {
          const response = await fetch(makeWebhookUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(deleteData)
          });
          const responseText = await response.text();
          
          if (!response.ok) {
            throw new Error('Failed to delete from Google Calendar');
          }

          editTaskForm.setAttribute('data-delete', '1');
          let actionInput = editTaskForm.querySelector('[name="action"]');
          if (!actionInput) {
            actionInput = document.createElement('input');
            actionInput.type = 'hidden';
            actionInput.name = 'action';
            editTaskForm.appendChild(actionInput);
          }
          actionInput.value = 'delete';
          document.getElementById('edit_task_modal').close();
          editTaskForm.submit();
        } catch (err) {
          alert('Failed to delete from Google Calendar. Please try again.');
        }
      });
    }

    editTaskForm.addEventListener('submit', async function(e) {
      if (isSubmittingToMake) return;
      e.preventDefault();
      isSubmittingToMake = true;

      try {
        const formData = new FormData(editTaskForm);
        const isDelete = editTaskForm.getAttribute('data-delete') === '1';
        const googleEventId = formData.get('google_event_id');
        const taskTypeSelect = editTaskForm.querySelector('[name="task_type"]');
        const taskTypeForMake = taskTypeSelect ? taskTypeSelect.options[taskTypeSelect.selectedIndex]?.text?.trim() : '';
        const userDesc = formData.get('description') || '';

        if (isDelete) {
          return;
        }

        // Build the staff-role summary and collect assignments
        let staffRoleSummary = '';
        const attendees = [];
        editTaskForm.querySelectorAll('.staff-role-row').forEach(row => {
          const roleSelect = row.querySelector('.role-select');
          const staffSelect = row.querySelector('.staff-select');
          const roleId = roleSelect.value;
          const staffId = staffSelect.value;
          const roleName = roleSelect.options[roleSelect.selectedIndex]?.text?.trim();
          const staffName = staffSelect.options[staffSelect.selectedIndex]?.text?.trim();
          
          if (roleId && staffId) {
            const staffMembers = staffData[roleId];
            const staffMember = staffMembers?.find(staff => staff.id === parseInt(staffId));
            
            if (staffMember?.email) {
              attendees.push({ email: staffMember.email });
            }
            
            if (roleName && staffName && staffName !== 'Select Staff') {
              staffRoleSummary += `${roleName} - ${staffName}\n`;
            }
          }
        });

        let finalDescriptionForMake = '';
        if (taskTypeForMake) {
            finalDescriptionForMake += taskTypeForMake.toUpperCase();
            const statusForMake = formData.get('status') || 'PENDING';
            finalDescriptionForMake += ' ' + statusForMake.toUpperCase();
        }

        if (userDesc) {
            if (finalDescriptionForMake) finalDescriptionForMake += '\n';
            finalDescriptionForMake += userDesc;
        }

        if (staffRoleSummary) {
            if (finalDescriptionForMake) finalDescriptionForMake += '\n\n';
            finalDescriptionForMake += staffRoleSummary;
        }

        const data = {
          action: 'edit',
          task_id: formData.get('task_id'),
          title: formData.get('title'),
          description: finalDescriptionForMake,
          deadline: formData.get('deadline'),
          task_type: formData.get('task_type'),
          status: formData.get('status'),
          google_event_id: googleEventId || null,
          attendees: [...attendees],
          create_if_not_exists: !googleEventId
        };

        try {
          const response = await fetch(makeWebhookUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          const responseText = await response.text();
          
          if (!response.ok) {
            throw new Error('Failed to sync with Google Calendar');
          }

          try {
            const responseData = JSON.parse(responseText);
            if (responseData.google_event_id) {
              document.querySelector('#edit_task_modal [name="google_event_id"]').value = responseData.google_event_id;
            }
          } catch (parseError) {
            // Ignore parse errors
          }

          editTaskForm.submit();
        } catch (err) {
          isSubmittingToMake = false;
          alert('Failed to sync with Google Calendar. Please try again.');
        }
      } catch (err) {
        isSubmittingToMake = false;
        alert('An error occurred. Please try again.');
      }
    });
  }
});
</script>


{% endblock 'content' %}